<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viyanta - Insurance Form Extraction</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: #2c3e50;
        }
        .step {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e74c3c;
            border-radius: 8px;
            background: #fff;
        }
        .step h3 {
            color: #e74c3c;
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }
        select, input[type="file"], button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #e74c3c;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background-color: #c0392b;
        }
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
        .error {
            border-left-color: #e74c3c;
            background: #fadbd8;
        }
        .success {
            border-left-color: #27ae60;
            background: #d5f4e6;
        }
        .form-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #f8f9fa;
        }
        .form-item {
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
        }
        .form-item:hover {
            background: #e9ecef;
        }
        .form-item.extractable {
            color: #27ae60;
            font-weight: bold;
        }
        .form-item.non-extractable {
            color: #7f8c8d;
        }
        .extraction-result {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            background: #f8f9fa;
        }
        .table-preview {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .table-preview th, .table-preview td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 12px;
        }
        .table-preview th {
            background: #34495e;
            color: white;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¶ Viyanta Insurance Form Extraction</h1>
            <p>Complete workflow for extracting structured data from insurance PDFs</p>
        </div>

        <!-- Step 1: Select Company -->
        <div class="step">
            <h3>üìã Step 1: Select Company</h3>
            <div class="form-group">
                <label for="companySelect">Choose Insurance Company:</label>
                <select id="companySelect" onchange="loadCompanyForms()">
                    <option value=""> -- Select Company --</option>
                </select>
            </div>
            <div id="companyResult" class="results" style="display: none;"></div>
        </div>

        <!-- Step 2: Upload PDF -->
        <div class="step">
            <h3>üìÑ Step 2: Upload PDF</h3>
            <div class="form-group">
                <label for="pdfFile">Select PDF File:</label>
                <input type="file" id="pdfFile" accept=".pdf">
            </div>
            <div class="form-group">
                <button onclick="uploadPDF()" id="uploadBtn" disabled>Upload PDF & Extract Forms</button>
            </div>
            <div id="uploadResult" class="results" style="display: none;"></div>
        </div>

        <!-- Step 3: Select Form to Extract -->
        <div class="step">
            <h3>üîç Step 3: Select Form to Extract</h3>
            <div class="form-group">
                <label>Available Forms (‚úÖ = Extractable):</label>
                <div id="formsList" class="form-list">
                    <div class="loading">Please select a company and upload PDF first</div>
                </div>
            </div>
            <div class="form-group">
                <button onclick="extractSelectedForm()" id="extractBtn" disabled>Extract Selected Form (Single Period)</button>
            </div>
            <div id="extractResult" class="results" style="display: none;"></div>
        </div>

        <!-- Step 4: AI Extract ALL Periods -->
        <div class="step">
            <h3>ü§ñ Step 4: AI Extract ALL Periods</h3>
            <div class="form-group">
                <label>AI Form Extractor - Extract ALL periods/years of a form:</label>
                <p style="font-size: 14px; color: #666; margin: 10px 0;">
                    The AI extractor finds and processes ALL instances of the selected form 
                    (e.g., L-4 Premium for Dec 2023, Dec 2022, Dec 2021, etc.)
                </p>
            </div>
            <div class="form-group">
                <button onclick="aiExtractSelectedForm()" id="aiExtractBtn" disabled>ü§ñ AI Extract ALL Periods</button>
            </div>
            <div id="aiExtractResult" class="results" style="display: none;"></div>
        </div>
    </div>

    <script>
        let selectedCompany = '';
        let selectedForm = '';
        let availableForms = [];

        // Load companies on page load
        document.addEventListener('DOMContentLoaded', loadCompanies);

        async function loadCompanies() {
            try {
                const response = await fetch('/templates/companies');
                const data = await response.json();
                
                const select = document.getElementById('companySelect');
                select.innerHTML = ' -- Select Company -- ';
                
                data.companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company;
                    option.textContent = company.toUpperCase();
                    select.appendChild(option);
                });
                
                showResult('companyResult', `Found ${data.companies.length} companies: ${data.companies.join(', ')}`, 'success');
            } catch (error) {
                showResult('companyResult', `Error loading companies: ${error.message}`, 'error');
            }
        }

        async function loadCompanyForms() {
            const select = document.getElementById('companySelect');
            selectedCompany = select.value;
            
            if (!selectedCompany) {
                document.getElementById('formsList').innerHTML = '<div class="loading">Please select a company first</div>';
                return;
            }

            document.getElementById('pdfFile').disabled = false;
            
            // Try to load existing forms
            try {
                const response = await fetch(`/templates/forms-with-templates/${selectedCompany}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayForms(data.forms);
                    showResult('companyResult', `Selected ${selectedCompany.toUpperCase()}. Found ${data.total_forms} forms, ${data.extractable_forms} extractable.`, 'success');
                }
            } catch (error) {
                document.getElementById('formsList').innerHTML = '<div class="loading">No PDF uploaded yet. Please upload PDF to see forms.</div>';
                showResult('companyResult', `Selected ${selectedCompany.toUpperCase()}. Upload PDF to see available forms.`, 'success');
            }
        }

        async function uploadPDF() {
            const fileInput = document.getElementById('pdfFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('uploadResult', 'Please select a PDF file', 'error');
                return;
            }
            
            if (!selectedCompany) {
                showResult('uploadResult', 'Please select a company first', 'error');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`/templates/upload?company=${selectedCompany}`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    showResult('uploadResult', 
                        `‚úÖ PDF uploaded successfully! Found ${data.forms_extracted.total_forms} forms.`, 
                        'success');
                    
                    // Load forms with template information
                    await loadFormsWithTemplates();
                } else {
                    showResult('uploadResult', `Upload failed: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('uploadResult', `Upload error: ${error.message}`, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload PDF & Extract Forms';
            }
        }

        async function loadFormsWithTemplates() {
            try {
                const response = await fetch(`/templates/forms-with-templates/${selectedCompany}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    availableForms = data.forms;
                    displayForms(data.forms);
                    
                    // Update upload result with template info
                    const uploadResult = document.getElementById('uploadResult');
                    uploadResult.innerHTML = `
                        ‚úÖ PDF uploaded successfully!<br>
                        üìä Found ${data.total_forms} forms<br>
                        ‚úÖ ${data.extractable_forms} forms are extractable<br>
                        üìÇ ${data.available_templates} templates available
                    `;
                }
            } catch (error) {
                console.error('Error loading forms with templates:', error);
            }
        }

        function displayForms(forms) {
            const formsList = document.getElementById('formsList');
            
            if (forms.length === 0) {
                formsList.innerHTML = '<div class="loading">No forms found</div>';
                return;
            }

            formsList.innerHTML = forms.map(form => `
                <div class="form-item ${form.extractable ? 'extractable' : 'non-extractable'}" 
                     onclick="selectForm('${form.form_no}')" 
                     data-form="${form.form_no}">
                    ${form.extractable ? '‚úÖ' : '‚ùå'} <strong>${form.form_no}</strong> - ${form.description}
                    <br><small>Pages: ${form.pages}${form.extractable ? ' | Template: ' + form.template_file : ''}</small>
                </div>
            `).join('');
        }

        function selectForm(formNo) {
            // Remove previous selection
            document.querySelectorAll('.form-item').forEach(item => {
                item.style.background = '';
            });

            // Highlight selected form
            const selectedItem = document.querySelector(`[data-form="${formNo}"]`);
            if (selectedItem) {
                selectedItem.style.background = '#3498db';
                selectedItem.style.color = 'white';
            }

            selectedForm = formNo;
            
            // Check if form is extractable and update both buttons
            const form = availableForms.find(f => f.form_no === formNo);
            const extractBtn = document.getElementById('extractBtn');
            const aiExtractBtn = document.getElementById('aiExtractBtn');
            
            if (form && form.extractable) {
                extractBtn.disabled = false;
                extractBtn.textContent = `Extract ${formNo} (Single Period)`;
                aiExtractBtn.disabled = false;
                aiExtractBtn.textContent = `ü§ñ AI Extract ALL Periods`;
            } else {
                extractBtn.disabled = true;
                extractBtn.textContent = 'No Template Available';
                aiExtractBtn.disabled = true;
                aiExtractBtn.textContent = 'ü§ñ No Template Available';
            }
            
            // Update button states
            updateExtractButtons();
        }

        async function extractSelectedForm() {
            if (!selectedForm || !selectedCompany) {
                showResult('extractResult', 'Please select a company and form first', 'error');
                return;
            }

            const extractBtn = document.getElementById('extractBtn');
            extractBtn.disabled = true;
            extractBtn.textContent = 'Extracting...';

            try {
                const response = await fetch(`/templates/extract-form/${selectedForm}?company=${selectedCompany}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayExtractionResult(data.data);
                } else {
                    showResult('extractResult', `Extraction failed: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('extractResult', `Extraction error: ${error.message}`, 'error');
            } finally {
                extractBtn.disabled = false;
                extractBtn.textContent = `Extract ${selectedForm}`;
            }
        }

        function displayExtractionResult(data) {
            const resultDiv = document.getElementById('extractResult');
            resultDiv.className = 'results success';
            resultDiv.style.display = 'block';
            
            let html = `
                <h4>‚úÖ Extraction Successful!</h4>
                <p><strong>Form:</strong> ${data['Form No']} - ${data.Title}</p>
                <p><strong>Period:</strong> ${data.Period}</p>
                <p><strong>Currency:</strong> ${data.Currency}</p>
                <p><strong>Pages Used:</strong> ${data.PagesUsed}</p>
                <p><strong>Total Rows:</strong> ${data.TotalRows}</p>
            `;

            if (data.Rows && data.Rows.length > 0 && data.FlatHeaders) {
                html += '<h5>üìä Extracted Data Preview (First 5 rows):</h5>';
                html += '<div class="extraction-result">';
                html += '<table class="table-preview">';
                
                // Headers
                html += '<tr>';
                data.FlatHeaders.forEach(header => {
                    html += `<th>${header}</th>`;
                });
                html += '</tr>';
                
                // Data rows (first 5)
                const previewRows = data.Rows.slice(0, 5);
                previewRows.forEach(row => {
                    html += '<tr>';
                    data.FlatHeaders.forEach(header => {
                        html += `<td>${row[header] || ''}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</table>';
                html += '</div>';
            }

            resultDiv.innerHTML = html;
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = `results ${type}`;
            element.innerHTML = message;
            element.style.display = 'block';
        }

        // ü§ñ AI Extraction Function - Extract ALL periods
        async function aiExtractSelectedForm() {
            if (!selectedForm || !selectedCompany) {
                showResult('aiExtractResult', 'Please select a company and form first', 'error');
                return;
            }

            const aiExtractBtn = document.getElementById('aiExtractBtn');
            aiExtractBtn.disabled = true;
            aiExtractBtn.textContent = 'ü§ñ AI Extracting ALL Periods...';

            try {
                const response = await fetch(`/templates/ai-extract-form/${selectedForm}?company=${selectedCompany}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayAIExtractionResult(data);
                } else {
                    showResult('aiExtractResult', `AI Extraction failed: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('aiExtractResult', `AI Extraction error: ${error.message}`, 'error');
            } finally {
                aiExtractBtn.disabled = false;
                aiExtractBtn.textContent = 'ü§ñ AI Extract ALL Periods';
            }
        }

        function displayAIExtractionResult(data) {
            const resultDiv = document.getElementById('aiExtractResult');
            resultDiv.className = 'results success';
            resultDiv.style.display = 'block';
            
            let html = `
                <h4>ü§ñ AI Extraction Complete!</h4>
                <p><strong>Company:</strong> ${data.company}</p>
                <p><strong>Form:</strong> ${data.form_no}</p>
                <p><strong>Total Periods Found:</strong> ${data.total_periods}</p>
                <p><strong>Extraction Method:</strong> ${data.extraction_method}</p>
                <p style="font-size: 12px; color: #666;">${data.message}</p>
            `;

            if (data.data && data.data.length > 0) {
                html += '<h5>üìä All Extracted Periods:</h5>';
                
                data.data.forEach((period, index) => {
                    html += `
                        <div style="border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px; background: #f9f9f9;">
                            <h6 style="margin: 0 0 10px 0; color: #2c3e50;">Period ${index + 1}: ${period.Form} - ${period.Title}</h6>
                            <p><strong>Period:</strong> ${period.Period}</p>
                            <p><strong>Currency:</strong> ${period.Currency}</p>
                            <p><strong>Page Used:</strong> ${period.PagesUsed}</p>
                            <p><strong>Rows Extracted:</strong> ${period.Rows ? period.Rows.length : 0}</p>
                            
                            ${period.Rows && period.Rows.length > 0 ? `
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; font-weight: bold; color: #3498db;">üìã View Data Preview (Click to expand)</summary>
                                    <div style="margin-top: 10px; max-height: 300px; overflow: auto;">
                                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                            <tr style="background: #3498db; color: white;">
                                                ${period.Headers ? period.Headers.map(h => `<th style="padding: 8px; border: 1px solid #ddd;">${h}</th>`).join('') : ''}
                                            </tr>
                                            ${period.Rows.slice(0, 3).map(row => `
                                                <tr>
                                                    ${period.Headers ? period.Headers.map(h => `<td style="padding: 8px; border: 1px solid #ddd;">${row[h] || ''}</td>`).join('') : ''}
                                                </tr>
                                            `).join('')}
                                            ${period.Rows.length > 3 ? `<tr><td colspan="${period.Headers ? period.Headers.length : 1}" style="text-align: center; font-style: italic; padding: 8px;">... and ${period.Rows.length - 3} more rows</td></tr>` : ''}
                                        </table>
                                    </div>
                                </details>
                            ` : '<p style="color: #888;">No data rows found for this period</p>'}
                        </div>
                    `;
                });
                
                html += `
                    <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #27ae60;">
                        <h6 style="margin: 0 0 10px 0; color: #27ae60;">‚úÖ Extraction Summary</h6>
                        <p><strong>Total Periods:</strong> ${data.total_periods}</p>
                        <p><strong>Total Rows Across All Periods:</strong> ${data.data.reduce((sum, period) => sum + (period.Rows ? period.Rows.length : 0), 0)}</p>
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">
                            üí° This AI extraction found multiple instances of the same form across different time periods in your PDF. 
                            Each period represents the same form structure but with data for different quarters/years.
                        </p>
                    </div>
                `;
            } else {
                html += '<p style="color: #e74c3c;">‚ùå No periods found or extraction failed</p>';
            }

            resultDiv.innerHTML = html;
        }

        // Enable upload button when file is selected
        document.getElementById('pdfFile').addEventListener('change', function() {
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = !this.files[0] || !selectedCompany;
        });

        // Enable upload button when company is selected
        document.getElementById('companySelect').addEventListener('change', function() {
            const uploadBtn = document.getElementById('uploadBtn');
            const fileInput = document.getElementById('pdfFile');
            uploadBtn.disabled = !this.value || !fileInput.files[0];
        });

        // Enable AI extract button when form is selected
        function updateExtractButtons() {
            const extractBtn = document.getElementById('extractBtn');
            const aiExtractBtn = document.getElementById('aiExtractBtn');
            
            const enabled = selectedForm && selectedCompany;
            extractBtn.disabled = !enabled;
            aiExtractBtn.disabled = !enabled;
            
            if (enabled) {
                extractBtn.textContent = `Extract ${selectedForm} (Single Period)`;
                aiExtractBtn.textContent = `ü§ñ AI Extract ALL Periods`;
            }
        }
    </script>
</body>
</html>
