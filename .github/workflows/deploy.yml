name: Viyanta Docker Deployment (Testing)

on:
  push:
    branches:
      - pipeline-docker-test

jobs:
  deploy:
    name: Deploy Viyanta Docker Test
    runs-on: [self-hosted, Linux, X64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Send Deployment Started
        continue-on-error: true
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"text\":\"ğŸ§ª *Test Deployment Started*\nğŸ“¦ Project: Viyanta Web (Testing)\nğŸŒ¿ Branch: ${GITHUB_REF_NAME}\nğŸ‘¤ By: ${GITHUB_ACTOR}\nğŸ’¬ Commit: ${{ github.event.head_commit.message }}\nğŸ“ Location: /home/ubuntu/viyanta_test\"}" \
          "${{ secrets.GOOGLE_CHAT_WEBHOOK }}"
      
      - name: Sync to Test Directory
        run: |
          echo "ğŸ“ Syncing to test directory: /home/ubuntu/viyanta_test"
          
          # Create directory if doesn't exist
          mkdir -p /home/ubuntu/viyanta_test
          
          # Sync files
          rsync -av --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='venv' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            ./ /home/ubuntu/viyanta_test/
          
          echo "âœ… Files synced to test directory"
      
      - name: Set Up Environment Files
        run: |
          cd /home/ubuntu/viyanta_test
          
          echo "ğŸ“‹ Setting up .env files..."
          
          # Copy from production if not exists
          if [ ! -f backend/.env ]; then
            if [ -f /home/ubuntu/code/viyanta_web/backend/.env ]; then
              cp /home/ubuntu/code/viyanta_web/backend/.env ./backend/.env
              echo "âœ… Copied backend/.env from production"
            else
              echo "âŒ ERROR: No .env file found in production"
              exit 1
            fi
          fi
          
          # Create root .env
          if [ ! -f .env ]; then
            cp backend/.env .env
            echo "âœ… Created root .env"
          fi
          
          echo "âœ… Environment files ready"
      
      - name: Deploy Docker (Test Environment)
        run: |
          cd /home/ubuntu/viyanta_test
          
          echo "ğŸ³ Deploying Docker containers..."
          echo "ğŸ“ Location: $(pwd)"
          echo "ğŸ”Œ Ports: Backend=8001, Frontend=8082, MySQL=3307"
          echo "âš ï¸  Production unaffected (PM2 on port 8000)"
          
          chmod +x deploy-docker.sh
          ./deploy-docker.sh
      
      - name: Verify Deployment
        run: |
          cd /home/ubuntu/viyanta_test
          
          echo "â³ Waiting for services (20s)..."
          sleep 20
          
          echo "ğŸ“Š Container status:"
          docker compose ps
          
          echo ""
          echo "ğŸ” Testing endpoints:"
          
          echo "Docker Backend (8001):"
          curl -s http://localhost:8001/ | head -3 || echo "âš ï¸  Backend not ready yet"
          
          echo ""
          echo "Docker Frontend (8082):"
          curl -s http://localhost:8082 | head -3 || echo "âš ï¸  Frontend not ready yet"
          
          echo ""
          echo "âœ… Production PM2 check:"
          pm2 list || echo "PM2 status check skipped"
          
          echo ""
          echo "ğŸŒ Test URL: http://98.130.11.14:8083"
      
      - name: Deployment Success
        if: success()
        continue-on-error: true
        run: |
          CONTAINERS=$(cd /home/ubuntu/viyanta_test && docker compose ps --format '{{.Service}}' | tr '\n' ', ' | sed 's/,$//')
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"text\":\"âœ… *Test Deployment Successful*\nğŸ“¦ Project: Viyanta Web (Testing)\nğŸŒ¿ Branch: ${GITHUB_REF_NAME}\nğŸ‘¤ By: ${GITHUB_ACTOR}\nğŸ³ Containers: ${CONTAINERS}\nğŸŒ Test URL: http://98.130.11.14:8083\nğŸ“ Location: /home/ubuntu/viyanta_test\n\nâœ… Production unaffected (PM2 running on port 8000)\"}" \
          "${{ secrets.GOOGLE_CHAT_WEBHOOK }}"
      
      - name: Deployment Failed
        if: failure()
        continue-on-error: true
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"text\":\"âŒ *Test Deployment Failed*\nğŸ“¦ Project: Viyanta Web (Testing)\nğŸŒ¿ Branch: ${GITHUB_REF_NAME}\nğŸ‘¤ By: ${GITHUB_ACTOR}\nğŸ“‹ Check GitHub Actions logs\n\nâœ… Production is safe and running\"}" \
          "${{ secrets.GOOGLE_CHAT_WEBHOOK }}"
