name: Viyanta Docker Deployment (Safe Parallel)

on:
  push:
    branches:
      - pipeline-docker-test
      - development_main

jobs:
  deploy:
    name: Deploy Viyanta with Docker
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Send Deployment Started
        continue-on-error: true
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"text\":\"ğŸš€ *Deployment Started*\nğŸ“¦ Project: Viyanta Web\nğŸŒ¿ Branch: ${GITHUB_REF_NAME}\nğŸ‘¤ By: ${GITHUB_ACTOR}\nğŸ’¬ Commit: ${{ github.event.head_commit.message }}\"}" \
          "${{ secrets.GOOGLE_CHAT_WEBHOOK }}"
      
      - name: Copy files to project directory
        run: |
          echo "ğŸ“ Syncing files to ~/viyanta_web..."
          rsync -av --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='venv' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            ./ ~/viyanta_web/
          echo "âœ… Files synced"
      
      - name: Copy environment files
        run: |
          echo "ğŸ“‹ Copying .env files..."
          # These should be set up on server beforehand
          if [ ! -f ~/viyanta_web/.env ]; then
            echo "âš ï¸  Warning: .env not found in ~/viyanta_web/"
          fi
          if [ ! -f ~/viyanta_web/backend/.env ]; then
            echo "âš ï¸  Warning: backend/.env not found"
          fi
      
      - name: Deploy Docker Containers
        run: |
          cd ~/viyanta_web
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“‹ Files present:"
          ls -la deploy-docker.sh docker-compose.yml
          
          echo "ğŸ³ Running Docker deployment..."
          chmod +x deploy-docker.sh
          ./deploy-docker.sh
      
      - name: Verify Deployment
        run: |
          cd ~/viyanta_web
          echo "â³ Waiting for stability..."
          sleep 15
          
          echo "ğŸ“Š Container status:"
          docker compose ps
          
          echo ""
          echo "ğŸ” Testing endpoints:"
          echo "Backend (8001):"
          curl -s http://localhost:8001/ | head -3 || echo "Backend check failed"
          
          echo ""
          echo "Frontend (8082):"
          curl -s http://localhost:8082 | head -3 || echo "Frontend check failed"
          
          echo ""
          echo "âœ… PM2 status (should still be running on 8000):"
          pm2 list || echo "PM2 not running or not installed"
      
      - name: Deployment Success Notification
        if: success()
        continue-on-error: true
        run: |
          CONTAINERS=$(cd ~/viyanta_web && docker compose ps --format '{{.Service}}' | tr '\n' ', ' | sed 's/,$//')
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"text\":\"âœ… *Deployment Successful*\nğŸ“¦ Project: Viyanta Web\nğŸŒ¿ Branch: ${GITHUB_REF_NAME}\nğŸ‘¤ By: ${GITHUB_ACTOR}\nğŸ³ Containers: ${CONTAINERS}\nğŸ”— Test: http://YOUR_SERVER_IP:8082\nâš ï¸  PM2 still running on port 8000\"}" \
          "${{ secrets.GOOGLE_CHAT_WEBHOOK }}"
      
      - name: Deployment Failed Notification
        if: failure()
        continue-on-error: true
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"text\":\"âŒ *Deployment Failed*\nğŸ“¦ Project: Viyanta Web\nğŸŒ¿ Branch: ${GITHUB_REF_NAME}\nğŸ‘¤ By: ${GITHUB_ACTOR}\nğŸ“‹ Check GitHub Actions logs\nâš ï¸  PM2 is unaffected and still running\"}" \
          "${{ secrets.GOOGLE_CHAT_WEBHOOK }}"
